# $Id$
# Maintainer: Felix Yan <felixonmars@archlinux.org>
# Maintainer: Antonio Rojas <arojas@archlinux.org>
# Contributor: Andrea Scarpino <andrea@archlinux.org>
# Contributor: Alexey D. <lq07829icatm at rambler.ru>

pkgbase=plasma-workspace
pkgname=(plasma-workspace plasma-wayland-session)
pkgver=5.14.4
pkgrel=2.1
pkgdesc='KDE Plasma Workspace'
arch=(x86_64)
url='https://www.kde.org/workspaces/plasmadesktop/'
license=(LGPL)
depends=(kjsembed knotifyconfig libksysguard ktexteditor libqalculate qt5-tools kde-cli-tools bc
         xorg-xrdb xorg-xsetroot kactivitymanagerd kholidays xorg-xmessage xorg-xprop milou prison kwin
         plasma-integration kdelibs4support)
makedepends=(extra-cmake-modules kdoctools gpsd baloo appstream-qt krunner networkmanager-qt kdesignerplugin)
groups=(plasma)
source=("https://download.kde.org/stable/plasma/$pkgver/$pkgbase-$pkgver.tar.xz"{,.sig} kde.pam
D15815.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=0d3ffccbcf6b52902c873599a7ffe9569a5b6d0e"
D15201.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=f4ac46f0569d791e9a14faf2576090e106d92d40"
D15202.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=06bbb92a173047d86f0a5e71ca1146f8514cdaf5"
D16040.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=a1eb7a03e9be49d020a64160d5323f53808c9e07"
D16042.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=06cb6cb61fec8b74a777e0d7eb795fe7da3ab12a"
D16065.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=00395be673abf557d35a290c1515ee7d1be7fb9e"
kdebug-395447.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=de6f8246ecabc3a4102c7c29ce3a7f6c4987cfec"
kdebug-399918.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=790f5bf48f2b6b8c23e2dafc8f0071066215d85d"
kdebug-370185.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=4d52641657d691a860848fc1f724fe0a141676c9"
# kdebug-401046.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=02541b8af06e1adbad3eb8563dbcdd8cf17b3cd6"
# kdebug-400723.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=145caeac105043d2d0bfba40717e9ed336471ccf"
fix-leak-in-XWindowTaskModel.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=38a50ce7c6570a2eb30fb1d37c7caa07881eff06"
fix-a-few-memory-leaks.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=e2ba40a4912ab60677e00b0ea7d3749b7965f798"
do-expensive-regexp-construction-earlier.patch::"https://cgit.kde.org/plasma-workspace.git/patch/?id=a46179d9497a4332f4091f75beab086c1b23b469"
)
sha256sums=('c5391f714d50828e10b58616ea8a9873cd6bd183039b8693bfc968c68d98af36'
            'SKIP'
            '00090291204baabe9d6857d3b1419832376dd2e279087d718b64792691e86739'
            'c72e8d2396e9c39bf888b60e83309294d3c352caaaaf17355b05921fa1aae214'
            '327b30a866c8652888849cd3a8b01ee564df7f53e0767b533809d0db7c3cdb32'
            'a321e092dad575315276d854bf81841621ad149bed6b6c964c83cac460e77c88'
            '1135ab48e35bb470f67ebaf4d942100ab5db0289a49456fc52215c47dae85669'
            '8332f13ebc73f38bd6a78f36f6b72e52d6ecf596fe7ec837fa7b991007f1a47c'
            '2d9794d6710425fec5618170d3de9e8deea79d734f396d1fa09ff577872b8e55'
            '03e1d9325675d968ea007423719ad251953592b2be73e8b5d5599515369f288f'
            'a5497f88dc26e2142554c3af85f7d83e7d6b4d2d0030a719cd2d6c95a47bdd28'
            '49eeb44d25b7d7120751dfee34823131097a37638922e0775b512c6d73676d63'
            'eb16c623f2d00ed86095560ba4f20a8cd306315ae8764c6aaecd70a811923cdc'
            'f82bcae3a05f616b778732765a76e5b25f30aea523ae3c7df16d8c12746d0e0b'
            'e9df00fdbb8828e1e3b0bbd37df20a87880f2832f9648f583d2d101407386ab0')
validpgpkeys=('2D1D5B0588357787DE9EE225EC94D18F7F05997E'  # Jonathan Riddell
              '0AAC775BB6437A8D9AF7A3ACFE0784117FBCE11D'  # Bhushan Shah <bshah@kde.org>
              'D07BD8662C56CB291B316EB2F5675605C74E02CF'  # David Edmundson
              '1FA881591C26B276D7A5518EEAAF29B42A678C20') # Marco Martin <notmart@gmail.com>

prepare() {
  mkdir -p build
  
  cd $pkgname-$pkgver
    msg "Add D15202.patch"
    patch -p1 -i ../D15202.patch
   msg "Add D16040.patch"
    patch -p1 -i ../D16040.patch
    msg "Add D16042.patch"
    patch -p1 -i ../D16042.patch
  msg "Add kdebug-395447.patch"
  patch -p1 -i ../kdebug-395447.patch
  msg "Add D15815.patch" # Fix in 5.15
    patch -p1 -i ../D15815.patch
  #msg "Add kdebug 401046 patch"
  #patch -p1 -i ../kdebug-401046.patch
  #msg "Add kdebug 400723 patch" # 1
  #patch -p1 -i ../kdebug-400723.patch
  msg "Add kdebug 370185 patch" 
  patch -p1 -i ../kdebug-370185.patch
  msg "fix-leak-in-XWindowTaskModel patch"
  patch -p1 -i ../fix-leak-in-XWindowTaskModel.patch
  msg "fix-a-few-memory-leaks"
  patch -p1 -i ../fix-a-few-memory-leaks.patch
  msg "do-expensive-regexp-construction-earlier.patch"
  patch -p1 -i ../do-expensive-regexp-construction-earlier.patch

# Nie nakłada się
#    msg "Add kdebug 399918 patch"
#    patch -p1 -i ../kdebug-399918.patch
    
}

build() {
  cd build
  cmake ../$pkgbase-$pkgver \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DCMAKE_INSTALL_LIBEXECDIR=lib \
    -DBUILD_TESTING=OFF
  make -j5
}

package_plasma-workspace() {
  optdepends=('plasma-workspace-wallpapers: additional wallpapers'
              'gpsd: GPS based geolocation' 'networkmanager-qt: IP based geolocation'
              'kdepim-addons: displaying PIM events in the calendar'
              'appmenu-qt4: global menu support for Qt4 applications'
              'appmenu-gtk-module: global menu support for GTK2 and some GTK3 applications'
              'qt5-virtualkeyboard: virtual keyboard support in lock screen'
              'baloo: Baloo search runner'
              'appstream-qt: package search runner')
  conflicts=(kuiserver)
  provides=(kuiserver notification-daemon)
  replaces=(kuiserver)
  backup=('etc/pam.d/kde')

  cd build
  make DESTDIR="$pkgdir" install

  install -Dm644 "$srcdir"/kde.pam "$pkgdir"/etc/pam.d/kde

  # Split plasma-wayland scripts
  rm -r "$pkgdir"/usr/share/wayland-sessions
}

package_plasma-wayland-session() {
  pkgdesc='Plasma Wayland session'
  depends=(plasma-workspace qt5-wayland kwayland-integration xorg-server-xwayland)
  groups=()

  install -Dm644 build/plasmawayland.desktop "$pkgdir"/usr/share/wayland-sessions/plasmawayland.desktop
}
