From a782d18c592696acf7f786401b72318280858d25 Mon Sep 17 00:00:00 2001
From: Xaver Hugl <xaver.hugl@gmail.com>
Date: Wed, 6 Jul 2022 11:12:13 +0200
Subject: [PATCH] backends/drm: don't create a new output every time

(cherry picked from commit 7d5d35928fc5cf332f0cb1ebe4b5561d14168fde)
---
 src/backends/drm/drm_gpu.cpp | 34 ++++++++++++++++------------------
 1 file changed, 16 insertions(+), 18 deletions(-)

diff --git a/src/backends/drm/drm_gpu.cpp b/src/backends/drm/drm_gpu.cpp
index 6aa2913a93..7a410173fd 100644
--- a/src/backends/drm/drm_gpu.cpp
+++ b/src/backends/drm/drm_gpu.cpp
@@ -266,30 +266,28 @@ bool DrmGpu::updateOutputs()
             }
             m_connectors << conn;
             m_allObjects << conn;
+            qCDebug(KWIN_DRM, "New %soutput on GPU %s: %s", conn->isNonDesktop() ? "non-desktop " : "", qPrintable(m_devNode), qPrintable(conn->modelName()));
+            const auto pipeline = conn->pipeline();
+            m_pipelines << pipeline;
+            if (conn->isNonDesktop()) {
+                auto leaseOutput = new DrmLeaseOutput(pipeline, m_leaseDevice);
+                m_leaseOutputs << leaseOutput;
+            } else {
+                auto output = new DrmOutput(pipeline);
+                m_drmOutputs << output;
+                m_outputs << output;
+                addedOutputs << output;
+                Q_EMIT outputAdded(output);
+            }
+            pipeline->setLayers(m_platform->renderBackend()->createPrimaryLayer(pipeline), m_platform->renderBackend()->createCursorLayer(pipeline));
+            pipeline->setActive(!conn->isNonDesktop());
+            pipeline->applyPendingChanges();
         } else {
             conn->updateProperties();
             if (conn->isConnected()) {
                 removedConnectors.removeOne(conn);
-            } else {
-                continue;
             }
         }
-        qCDebug(KWIN_DRM, "New %soutput on GPU %s: %s", conn->isNonDesktop() ? "non-desktop " : "", qPrintable(m_devNode), qPrintable(conn->modelName()));
-        const auto pipeline = conn->pipeline();
-        m_pipelines << pipeline;
-        if (conn->isNonDesktop()) {
-            auto leaseOutput = new DrmLeaseOutput(pipeline, m_leaseDevice);
-            m_leaseOutputs << leaseOutput;
-        } else {
-            auto output = new DrmOutput(pipeline);
-            m_drmOutputs << output;
-            m_outputs << output;
-            addedOutputs << output;
-            Q_EMIT outputAdded(output);
-        }
-        pipeline->setLayers(m_platform->renderBackend()->createPrimaryLayer(pipeline), m_platform->renderBackend()->createCursorLayer(pipeline));
-        pipeline->setActive(!conn->isNonDesktop());
-        pipeline->applyPendingChanges();
     }
     for (const auto &connector : qAsConst(removedConnectors)) {
         if (auto output = findOutput(connector->id())) {
-- 
GitLab

