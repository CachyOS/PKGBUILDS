From 04b2d13a0d7f7b2d5c8f0bde340da6da929104be Mon Sep 17 00:00:00 2001
From: Mario Aichinger <aichingm@gmail.com>
Date: Wed, 30 Sep 2020 11:59:56 +0200
Subject: [PATCH 1/4] add open-with entry to the context menu of the
 filebrowser

---
 addons/filebrowser/CMakeLists.txt             |  1 +
 addons/filebrowser/katefilebrowser.cpp        | 82 +++++++++++++++++++
 addons/filebrowser/katefilebrowser.h          |  8 ++
 .../katefilebrowseropenwithmenu.cpp           | 23 ++++++
 .../filebrowser/katefilebrowseropenwithmenu.h | 49 +++++++++++
 5 files changed, 163 insertions(+)
 create mode 100644 addons/filebrowser/katefilebrowseropenwithmenu.cpp
 create mode 100644 addons/filebrowser/katefilebrowseropenwithmenu.h

diff --git a/addons/filebrowser/CMakeLists.txt b/addons/filebrowser/CMakeLists.txt
index 03590fcb1..359b89539 100644
--- a/addons/filebrowser/CMakeLists.txt
+++ b/addons/filebrowser/CMakeLists.txt
@@ -22,6 +22,7 @@ target_sources(
     katefilebrowserconfig.cpp
     katefilebrowser.cpp
     katebookmarkhandler.cpp
+    katefilebrowseropenwithmenu.cpp
 )
 
 kcoreaddons_desktop_to_json(katefilebrowserplugin katefilebrowserplugin.desktop)
diff --git a/addons/filebrowser/katefilebrowser.cpp b/addons/filebrowser/katefilebrowser.cpp
index dd4911519..beb9cdee5 100644
--- a/addons/filebrowser/katefilebrowser.cpp
+++ b/addons/filebrowser/katefilebrowser.cpp
@@ -34,6 +34,19 @@
 #include <QLineEdit>
 #include <QStyle>
 #include <QVBoxLayout>
+#include <QMenu>
+
+#include <kio_version.h>
+#if KIO_VERSION < QT_VERSION_CHECK(5, 71, 0)
+#   include <KOpenWithDialog>
+#   include <KRun>
+#else
+#   include <KIO/ApplicationLauncherJob>
+#   include <KIO/JobUiDelegate>
+#endif
+#include <KApplicationTrader>
+#include "katefilebrowseropenwithmenu.h"
+
 
 // END Includes
 
@@ -106,6 +119,8 @@ KateFileBrowser::KateFileBrowser(KTextEditor::MainWindow *mainWindow, QWidget *p
 
     connect(m_dirOperator, &KDirOperator::fileSelected, this, &KateFileBrowser::fileSelected);
     connect(m_mainWindow, &KTextEditor::MainWindow::viewChanged, this, &KateFileBrowser::autoSyncFolder);
+
+    connect(m_dirOperator, &KDirOperator::contextMenuAboutToShow, this, &KateFileBrowser::contextMenuAboutToShow);
 }
 
 KateFileBrowser::~KateFileBrowser()
@@ -212,6 +227,73 @@ void KateFileBrowser::setDir(const QUrl &u)
     m_dirOperator->setUrl(newurl, true);
 }
 
+void KateFileBrowser::contextMenuAboutToShow(const KFileItem &item, QMenu *menu)
+{
+  if(m_openWithMenu == nullptr) {
+    m_openWithMenu = new KateFileBrowserOpenWithMenu(i18nc("@action:inmenu", "Open With"), this);
+    menu->insertMenu(menu->actions().at(1), m_openWithMenu);
+    connect(m_openWithMenu, &QMenu::aboutToShow, this, &KateFileBrowser::fixOpenWithMenu);
+    connect(m_openWithMenu, &QMenu::triggered, this, &KateFileBrowser::openWithMenuAction);
+  }
+  m_openWithMenu->setItem(item);
+}
+
+void KateFileBrowser::fixOpenWithMenu()
+{
+    KateFileBrowserOpenWithMenu *menu = static_cast<KateFileBrowserOpenWithMenu *>(sender());
+    menu->clear();
+
+    // get a list of appropriate services.
+    QMimeType mime = menu->item().determineMimeType();
+
+    QAction *a = nullptr;
+    const KService::List offers = KApplicationTrader::queryByMimeType(mime.name());
+    // for each one, insert a menu item...
+    for (const auto &service : offers) {
+        if (service->name() == QLatin1String("Kate")) {
+            continue;
+        }
+        a = menu->addAction(QIcon::fromTheme(service->icon()), service->name());
+        a->setData(QVariant(QList<QString>({service->entryPath(), menu->item().url().toString()})));
+    }
+    // append "Other..." to call the KDE "open with" dialog.
+    a = menu->addAction(i18n("&Other..."));
+    a->setData(QVariant(QList<QString>({QString(), menu->item().url().toString()})));
+
+}
+
+void KateFileBrowser::openWithMenuAction(QAction *a)
+{
+    const QString application = a->data().toStringList().first();
+    const QString fileName = a->data().toStringList().last();
+    const QList<QUrl> list({QUrl(fileName)});
+
+#if KIO_VERSION < QT_VERSION_CHECK(5, 71, 0)
+    if (application.isEmpty()) {
+        // display "open with" dialog
+        KOpenWithDialog dlg(list);
+        if (dlg.exec()) {
+            KRun::runService(*dlg.service(), list, this);
+        }
+        return;
+    }
+
+    KService::Ptr app = KService::serviceByDesktopPath(application);
+    if (app) {
+        KRun::runService(*app, list, this);
+    } else {
+        KMessageBox::error(this, i18n("Application '%1' not found.", application), i18n("Application not found"));
+    }
+#else
+    KService::Ptr app = KService::serviceByDesktopPath(application);
+    // If app is null, ApplicationLauncherJob will invoke the open-with dialog
+    auto *job = new KIO::ApplicationLauncherJob(app);
+    job->setUrls(list);
+    job->setUiDelegate(new KIO::JobUiDelegate(KJobUiDelegate::AutoHandlingEnabled, this));
+    job->start();
+#endif
+
+}
 // END Public Slots
 
 // BEGIN Private Slots
diff --git a/addons/filebrowser/katefilebrowser.h b/addons/filebrowser/katefilebrowser.h
index 858ade603..af715da7a 100644
--- a/addons/filebrowser/katefilebrowser.h
+++ b/addons/filebrowser/katefilebrowser.h
@@ -17,6 +17,9 @@
 
 #include <QUrl>
 #include <QWidget>
+#include <QMenu>
+
+#include "katefilebrowseropenwithmenu.h"
 
 class KateBookmarkHandler;
 class KActionCollection;
@@ -76,6 +79,10 @@ private Q_SLOTS:
     void updateUrlNavigator(const QUrl &u);
     void setActiveDocumentDir();
     void autoSyncFolder();
+    void contextMenuAboutToShow(const KFileItem &item, QMenu *menu);
+    void fixOpenWithMenu();
+    void openWithMenuAction(QAction *a);
+
 
 protected:
     QUrl activeDocumentUrl();
@@ -96,6 +103,7 @@ private:
     KDirOperator *m_dirOperator;
     KHistoryComboBox *m_filter;
     QAction *m_autoSyncFolder = nullptr;
+    KateFileBrowserOpenWithMenu *m_openWithMenu = nullptr;
 
     KTextEditor::MainWindow *m_mainWindow;
 };
diff --git a/addons/filebrowser/katefilebrowseropenwithmenu.cpp b/addons/filebrowser/katefilebrowseropenwithmenu.cpp
new file mode 100644
index 000000000..92749b6ce
--- /dev/null
+++ b/addons/filebrowser/katefilebrowseropenwithmenu.cpp
@@ -0,0 +1,23 @@
+/* This file is part of the KDE project
+   SPDX-FileCopyrightText: 2020 Mario Aichinger <aichingm@gmail.com>
+
+   SPDX-License-Identifier: LGPL-2.0-only
+*/
+
+// BEGIN Includes
+#include "katefilebrowseropenwithmenu.h"
+// END Includes
+
+// BEGIN KateFileBrowserOpenWithMenu
+
+KateFileBrowserOpenWithMenu::KateFileBrowserOpenWithMenu(const QString &title, QWidget *parent) : QMenu(title, parent)
+{
+}
+
+KateFileBrowserOpenWithMenu::~KateFileBrowserOpenWithMenu()
+{
+}
+
+// END Constructor/Destructor
+
+// kate: space-indent on; indent-width 2; replace-tabs on;
diff --git a/addons/filebrowser/katefilebrowseropenwithmenu.h b/addons/filebrowser/katefilebrowseropenwithmenu.h
new file mode 100644
index 000000000..8761a57b8
--- /dev/null
+++ b/addons/filebrowser/katefilebrowseropenwithmenu.h
@@ -0,0 +1,49 @@
+/* This file is part of the KDE project
+   SPDX-FileCopyrightText: 2020 Mario Aichinger <aichingm@gmail.com>
+
+   SPDX-License-Identifier: LGPL-2.0-only
+*/
+
+#ifndef KATE_FILEBROWSEROPENWITHMENU_H
+#define KATE_FILEBROWSEROPENWITHMENU_H
+
+#include <QMenu>
+#include <KFileItem>
+
+/*
+    The KateFileBrowserOpenWithMenu extends a QMenu with a KFileItem property, used to
+    pass data of the selected file to the creation of the submenu.
+*/
+
+class KateFileBrowserOpenWithMenu : public QMenu
+{
+    Q_OBJECT
+    Q_PROPERTY(KFileItem item READ item WRITE setItem)
+
+public:
+    explicit KateFileBrowserOpenWithMenu(const QString &title, QWidget *parent = nullptr);
+    ~KateFileBrowserOpenWithMenu();
+
+    void setItem(KFileItem item)
+    {
+        m_item = item;
+    }
+
+    KFileItem item()
+    {
+        return m_item;
+    }
+
+public Q_SLOTS:
+
+private Q_SLOTS:
+
+protected:
+
+private:
+    KFileItem m_item;
+};
+
+#endif // KATE_FILEBROWSEROPENWITHMENU_H
+
+// kate: space-indent on; indent-width 2; replace-tabs on;
-- 
GitLab


From f96fbb39dc80a5e02d193464abe84429e5f07391 Mon Sep 17 00:00:00 2001
From: Mario Aichinger <aichingm@gmail.com>
Date: Wed, 30 Sep 2020 14:13:50 +0200
Subject: [PATCH 2/4] fix indentation

---
 addons/filebrowser/katefilebrowser.cpp | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/addons/filebrowser/katefilebrowser.cpp b/addons/filebrowser/katefilebrowser.cpp
index beb9cdee5..f2864972a 100644
--- a/addons/filebrowser/katefilebrowser.cpp
+++ b/addons/filebrowser/katefilebrowser.cpp
@@ -229,13 +229,13 @@ void KateFileBrowser::setDir(const QUrl &u)
 
 void KateFileBrowser::contextMenuAboutToShow(const KFileItem &item, QMenu *menu)
 {
-  if(m_openWithMenu == nullptr) {
-    m_openWithMenu = new KateFileBrowserOpenWithMenu(i18nc("@action:inmenu", "Open With"), this);
-    menu->insertMenu(menu->actions().at(1), m_openWithMenu);
-    connect(m_openWithMenu, &QMenu::aboutToShow, this, &KateFileBrowser::fixOpenWithMenu);
-    connect(m_openWithMenu, &QMenu::triggered, this, &KateFileBrowser::openWithMenuAction);
-  }
-  m_openWithMenu->setItem(item);
+    if(m_openWithMenu == nullptr) {
+        m_openWithMenu = new KateFileBrowserOpenWithMenu(i18nc("@action:inmenu", "Open With"), this);
+        menu->insertMenu(menu->actions().at(1), m_openWithMenu);
+        connect(m_openWithMenu, &QMenu::aboutToShow, this, &KateFileBrowser::fixOpenWithMenu);
+        connect(m_openWithMenu, &QMenu::triggered, this, &KateFileBrowser::openWithMenuAction);
+    }
+    m_openWithMenu->setItem(item);
 }
 
 void KateFileBrowser::fixOpenWithMenu()
-- 
GitLab


From a43e15434505d773d0b292efe6ab8c1e7b5d9a8b Mon Sep 17 00:00:00 2001
From: Mario Aichinger <aichingm@gmail.com>
Date: Wed, 30 Sep 2020 17:07:22 +0200
Subject: [PATCH 3/4] add separator after open-with entry

---
 addons/filebrowser/katefilebrowser.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/addons/filebrowser/katefilebrowser.cpp b/addons/filebrowser/katefilebrowser.cpp
index f2864972a..d5ea4bdf5 100644
--- a/addons/filebrowser/katefilebrowser.cpp
+++ b/addons/filebrowser/katefilebrowser.cpp
@@ -232,6 +232,7 @@ void KateFileBrowser::contextMenuAboutToShow(const KFileItem &item, QMenu *menu)
     if(m_openWithMenu == nullptr) {
         m_openWithMenu = new KateFileBrowserOpenWithMenu(i18nc("@action:inmenu", "Open With"), this);
         menu->insertMenu(menu->actions().at(1), m_openWithMenu);
+        menu->insertSeparator(menu->actions().at(2));
         connect(m_openWithMenu, &QMenu::aboutToShow, this, &KateFileBrowser::fixOpenWithMenu);
         connect(m_openWithMenu, &QMenu::triggered, this, &KateFileBrowser::openWithMenuAction);
     }
-- 
GitLab


From f51ab25ae7dfc2a7e3b222ca8bfb29b9a57ff0de Mon Sep 17 00:00:00 2001
From: Mario Aichinger <aichingm@gmail.com>
Date: Wed, 30 Sep 2020 19:39:19 +0200
Subject: [PATCH 4/4] change license to LGPL-2.0-or-later

---
 addons/filebrowser/katefilebrowseropenwithmenu.cpp | 2 +-
 addons/filebrowser/katefilebrowseropenwithmenu.h   | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/addons/filebrowser/katefilebrowseropenwithmenu.cpp b/addons/filebrowser/katefilebrowseropenwithmenu.cpp
index 92749b6ce..61067593f 100644
--- a/addons/filebrowser/katefilebrowseropenwithmenu.cpp
+++ b/addons/filebrowser/katefilebrowseropenwithmenu.cpp
@@ -1,7 +1,7 @@
 /* This file is part of the KDE project
    SPDX-FileCopyrightText: 2020 Mario Aichinger <aichingm@gmail.com>
 
-   SPDX-License-Identifier: LGPL-2.0-only
+   SPDX-License-Identifier: LGPL-2.0-or-later
 */
 
 // BEGIN Includes
diff --git a/addons/filebrowser/katefilebrowseropenwithmenu.h b/addons/filebrowser/katefilebrowseropenwithmenu.h
index 8761a57b8..de0ec3bf3 100644
--- a/addons/filebrowser/katefilebrowseropenwithmenu.h
+++ b/addons/filebrowser/katefilebrowseropenwithmenu.h
@@ -1,7 +1,7 @@
 /* This file is part of the KDE project
    SPDX-FileCopyrightText: 2020 Mario Aichinger <aichingm@gmail.com>
 
-   SPDX-License-Identifier: LGPL-2.0-only
+   SPDX-License-Identifier: LGPL-2.0-or-later
 */
 
 #ifndef KATE_FILEBROWSEROPENWITHMENU_H
-- 
GitLab

